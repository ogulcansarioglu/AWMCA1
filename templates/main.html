{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ParkFinder</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/cerulean/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <!-- Your custom CSS -->
  <style>
      /* styles.css */

.sidebar {
  height: 80vh;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  right: 0;
  background-color: white;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
}

.sidebar a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.sidebar a:hover {
  color: #f1f1f1;
}
</style>

</head>
<body>

  <header>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">ParkFinder</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <nav class="navbar navbar-expand-lg navbar-light bg-light">
  <!-- ... other navbar code ... -->
            <form class="d-flex" role="search">
            <input class="form-control me-2" type="search" placeholder="Search Hotels" aria-label="Search" id="parkSearch" onkeyup="handleSearch()">
            <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </nav>

        </div>
      </div>
    </nav>
  </header>

  <main>
    <!-- Main content area -->
    <div class="d-flex">
     <div id="map" style="height: 80vh; width: 80vh;"></div>
     <!-- Add this inside your index.html where the sidebar is defined -->
    <div id="sidebar" class="sidebar">
    <div id="parkDetails" class="park-details">
    <!-- Park details will be dynamically inserted here -->
  </div>
</div>

    <!-- Park details go here -->
  </div>
</div>

  </main>

  <footer class="bg-light text-center text-lg-start">
    <!-- Footer -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.2);">
      © 2023 ParkFinder
    </div>
  </footer>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootlint@1.1.0/dist/browser/bootlint.min.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Your custom JS -->
  <script>
    var map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function parseLatLngFromWKT(wkt) {
      const match = wkt.match(/POINT \(([^ ]+) ([^ ]+)\)/);
      if (match) {
        const longitude = parseFloat(match[1]);
        const latitude = parseFloat(match[2]);
        return { latitude, longitude };
      } else {
        return null;
      }
    }

    function createHotelLink(hotelName) {
    var encodedHotelName = encodeURIComponent(hotelName);
    var searchUrl = `https://www.google.com/search?q=${encodedHotelName}`;
    return `<a href="${searchUrl}" target="_blank">${hotelName}</a>`;
}

    var allMarkers = []; // Global array to store markers

    function addHotelMarkers(data) {
      allMarkers.forEach(marker => map.removeLayer(marker));
      allMarkers = [];

      data.forEach(item => {
        const latLng = parseLatLngFromWKT(item.location);
        if (latLng) {
          var marker = L.marker([latLng.latitude, latLng.longitude]).addTo(map)
            .bindPopup(`<b>${item.name}</b><br>${item.address}<br> ${createHotelLink(item.name)}`);

          allMarkers.push(marker);
        } else {
          console.error('Invalid LatLng data for item:', item);
        }
      });
    }

    function handleSearch() {
      var searchQuery = document.getElementById('parkSearch').value.toLowerCase();

      fetch('/api/v1/hotels/')
        .then(response => response.json())
        .then(data => {
          var filteredData = data.filter(item => item.name.toLowerCase().includes(searchQuery));

          if (filteredData.length > 0) {
            const firstMatch = filteredData[0];
            const latLng = parseLatLngFromWKT(firstMatch.location);

            if (latLng) {
              map.setView([latLng.latitude, latLng.longitude], 15);
            }

            addHotelMarkers(filteredData);
          } else {
            console.log('No matching hotels found');
          }
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    fetch('/api/v1/hotels/')
      .then(response => response.json())
      .then(data => {
        addHotelMarkers(data);
      }).catch(error => console.error('Error fetching hotel data:', error));

    function closeNav() {
      document.getElementById('sidebar').style.width = "0";
    }
  </script>

</body>
</html>
